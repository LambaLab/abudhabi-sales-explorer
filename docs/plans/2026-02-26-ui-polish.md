# UI Polish Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Apply 9 UI improvements: two-phase analysis (short + deeper on demand), floating input bar, bar charts by default with type toggle, cleaner charts, per-post date range selector, and ReplyInput polish.

**Architecture:** Hybrid state â€” post store holds API-fetched text (`shortText`, `fullText`, `summaryStats`) and persists it; chart type is global in `useSettings`; per-chart date range lives in local `useState` (ephemeral).

**Tech Stack:** React 18, Recharts, Tailwind CSS v4, Anthropic SDK (edge function), Vitest, DuckDB-WASM

---

### Task 1: `api/explain.js` â€” Two-mode endpoint

**Files:**
- Modify: `api/explain.js`

**Context:** Currently always uses a 2-3 paragraph prompt with `max_tokens: 600`. Need to add `mode` param: `'short'` (2-3 sentences, 150 tokens) or `'full'` (existing, 600 tokens). Default `mode` to `'full'` so existing callers without `mode` still work.

**Step 1: Implement the two-mode logic**

Replace `api/explain.js` with:

```js
import Anthropic from '@anthropic-ai/sdk'

export const config = { runtime: 'edge' }

const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY })

const SHORT_PROMPT = `You are a real estate market analyst specializing in Abu Dhabi property.
Write exactly 2-3 sentences summarizing the single most important insight with specific AED numbers.
No headers, no bullets, flowing prose only.`

const FULL_PROMPT = `You are a real estate market analyst specializing in Abu Dhabi property.
Write clear, accessible analysis for sophisticated investors.
Rules:
- Write exactly 2-3 paragraphs of flowing prose â€” NO headers, NO bullet points, NO markdown
- Lead with the single most important insight
- Use specific AED numbers and percentages
- Compare and contrast when multiple series exist
- End with a brief forward-looking observation if the data supports one
- Keep language accessible to non-experts while remaining precise`

export default async function handler(req) {
  if (req.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), { status: 405, headers: { 'Content-Type': 'application/json' } })
  }

  let prompt, intent, summaryStats, mode
  try {
    const body = await req.json()
    prompt       = body.prompt
    intent       = body.intent
    summaryStats = body.summaryStats
    mode         = body.mode ?? 'full'
  } catch {
    return new Response(JSON.stringify({ error: 'Invalid JSON body' }), { status: 400, headers: { 'Content-Type': 'application/json' } })
  }
  if (!prompt || !intent || !summaryStats) {
    return new Response(JSON.stringify({ error: 'Missing required fields: prompt, intent, summaryStats' }), { status: 400, headers: { 'Content-Type': 'application/json' } })
  }

  const systemPrompt = mode === 'short' ? SHORT_PROMPT : FULL_PROMPT
  const maxTokens    = mode === 'short' ? 150 : 600

  const userMessage = `Original question: "${prompt}"

Query type: ${intent.queryType}
Filters applied: ${JSON.stringify(intent.filters)}

Key data:
${JSON.stringify(summaryStats, null, 2)}

Write the analyst commentary now.`

  const stream = anthropic.messages.stream({
    model: 'claude-opus-4-5',
    max_tokens: maxTokens,
    system: systemPrompt,
    messages: [{ role: 'user', content: userMessage }],
  })

  const readable = new ReadableStream({
    async start(controller) {
      try {
        for await (const chunk of stream) {
          if (chunk.type === 'content_block_delta' && chunk.delta?.type === 'text_delta') {
            controller.enqueue(new TextEncoder().encode(chunk.delta.text))
          }
        }
        controller.close()
      } catch (err) {
        controller.error(err)
      }
    },
  })

  return new Response(readable, {
    headers: { 'Content-Type': 'text/plain; charset=utf-8' },
  })
}
```

**Step 2: Commit**

```bash
git add api/explain.js
git commit -m "feat: add mode param to explain API (short/full)"
```

---

### Task 2: `useSettings` â€” Add `chartType`

**Files:**
- Modify: `src/hooks/useSettings.js`

**Context:** Currently DEFAULTS has `defaultDateRange`, `customFrom`, `customTo`. Add `chartType: 'bar'`. The `useSettings` hook stores to `'ad_settings'` in localStorage and merges with DEFAULTS on load, so new keys appear automatically for existing users.

**Step 1: Write the failing test**

In `src/hooks/useSettings.js` â€” no test file exists yet. Create `src/hooks/useSettings.test.js`:

```js
import { describe, it, expect, beforeEach } from 'vitest'
import { renderHook, act } from '@testing-library/react'
import { useSettings } from './useSettings'

beforeEach(() => localStorage.clear())

describe('useSettings', () => {
  it('defaults chartType to bar', () => {
    const { result } = renderHook(() => useSettings())
    expect(result.current.settings.chartType).toBe('bar')
  })

  it('persists chartType update to localStorage', () => {
    const { result } = renderHook(() => useSettings())
    act(() => result.current.updateSettings({ chartType: 'line' }))
    expect(result.current.settings.chartType).toBe('line')
    const saved = JSON.parse(localStorage.getItem('ad_settings'))
    expect(saved.chartType).toBe('line')
  })
})
```

**Step 2: Run to verify it fails**

```bash
cd /Users/nagi/abudhabi-sales-explorer && npx vitest run src/hooks/useSettings.test.js
```

Expected: FAIL â€” `chartType` is undefined.

**Step 3: Add `chartType` to DEFAULTS in `src/hooks/useSettings.js`**

Change the DEFAULTS object from:
```js
const DEFAULTS = {
  defaultDateRange: '12m',
  customFrom: '',
  customTo: '',
}
```
To:
```js
const DEFAULTS = {
  defaultDateRange: '12m',
  customFrom: '',
  customTo: '',
  chartType: 'bar',
}
```

**Step 4: Run tests to verify pass**

```bash
npx vitest run src/hooks/useSettings.test.js
```

Expected: PASS (2 tests).

**Step 5: Commit**

```bash
git add src/hooks/useSettings.js src/hooks/useSettings.test.js
git commit -m "feat: add chartType setting (default: bar)"
```

---

### Task 3: `usePostStore` â€” Add `shortText`, `fullText`, `isExpanded`, `summaryStats` fields

**Files:**
- Modify: `src/hooks/usePostStore.js`
- Modify: `src/hooks/usePostStore.test.js`

**Context:** Bump `STORAGE_KEY` to `'ad_posts_v3'` (schema change). New fields on the post model:
- `shortText` â€” 2-3 sentence summary (set by initial analysis)
- `fullText` â€” full analysis, fetched on demand (null until requested)
- `isExpanded` â€” whether fullText is visible (default: false)
- `summaryStats` â€” stored so `analyzeDeep` can reuse it without re-querying

`analysisText` remains as-is for backwards compatibility with `ReplyCard`.

**Step 1: Add tests for new fields in `src/hooks/usePostStore.test.js`**

Open `src/hooks/usePostStore.test.js` and add to the existing test suite:

```js
describe('shortText / fullText / isExpanded', () => {
  it('patchPost can set shortText and fullText', () => {
    const { result } = renderHook(() => usePostStore())
    act(() => result.current.addPost({ id: '1', shortText: null, fullText: null, isExpanded: false, replies: [] }))
    act(() => result.current.patchPost('1', { shortText: 'short', fullText: 'full', isExpanded: true }))
    const post = result.current.posts.find(p => p.id === '1')
    expect(post.shortText).toBe('short')
    expect(post.fullText).toBe('full')
    expect(post.isExpanded).toBe(true)
  })
})
```

**Step 2: Run to verify test passes** (patchPost already works generically â€” this should pass immediately)

```bash
npx vitest run src/hooks/usePostStore.test.js
```

Expected: PASS â€” patchPost is already generic.

**Step 3: Bump storage key in `src/hooks/usePostStore.js`**

Change:
```js
const STORAGE_KEY = 'ad_posts_v2'
```
To:
```js
const STORAGE_KEY = 'ad_posts_v3'
```

**Step 4: Commit**

```bash
git add src/hooks/usePostStore.js src/hooks/usePostStore.test.js
git commit -m "feat: bump post store schema to v3 (shortText, fullText, isExpanded, summaryStats)"
```

---

### Task 4: `useAnalysis` â€” Short mode initial analysis + `analyzeDeep`

**Files:**
- Modify: `src/hooks/useAnalysis.js`

**Context:**
1. The initial `analyze()` call should pass `mode: 'short'` to `streamExplain` and store result as both `shortText` and `analysisText` (for compat).
2. Also store `summaryStats` on the post so `analyzeDeep` can reuse it.
3. Add `analyzeDeep(postId)` â€” fetches `fullText` on demand with `mode: 'full'`.
4. Export `analyzeDeep` from the hook.

**Step 1: Modify `streamExplain` to accept and forward `mode`**

Change the `streamExplain` function signature and body:

```js
async function streamExplain(prompt, intent, summaryStats, signal, mode = 'full') {
  const res = await fetch('/api/explain', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt, intent, summaryStats, mode }),
    signal,
  })
  if (!res.ok) throw new Error(`Explain API error: ${res.status}`)

  const reader  = res.body.getReader()
  const decoder = new TextDecoder()
  let full = ''

  try {
    while (true) {
      if (signal?.aborted) {
        await reader.cancel()
        break
      }
      const { done, value } = await reader.read()
      if (done) break
      full += decoder.decode(value, { stream: true })
    }
  } finally {
    reader.releaseLock()
  }
  return full
}
```

**Step 2: In `analyze()`, store `summaryStats` and use `mode: 'short'`**

In the `analyze` callback, change Step 4 and Step 5:

```js
      // â”€â”€ Step 4: stream analyst text (short mode for initial summary) â”€â”€
      const shortText = await streamExplain(prompt, intent, summaryStats, signal, 'short')

      if (signal.aborted) return

      // â”€â”€ Step 5: finalise â”€â”€
      patchPost(postId, {
        status: 'done',
        analysisText: shortText,   // compat alias
        shortText,
        summaryStats,              // stored for analyzeDeep
        fullText: null,
        isExpanded: false,
      })
```

**Step 3: Add `analyzeDeep` callback in `useAnalysis`**

Add after the `analyze` callback, before the `analyzeReply` callback:

```js
  /**
   * Fetch the full analysis for an already-completed post.
   * If fullText already exists, just toggle isExpanded.
   * Otherwise stream mode:'full' and store the result.
   */
  const analyzeDeep = useCallback(async (postId) => {
    const post = getPost(postId)
    if (!post) return

    // Already fetched â€” just expand
    if (post.fullText) {
      patchPost(postId, { isExpanded: !post.isExpanded })
      return
    }

    abortRef.current?.abort()
    const controller = new AbortController()
    abortRef.current = controller
    const { signal } = controller

    setActivePostId(postId)
    patchPost(postId, { status: 'deepening' })

    try {
      const fullText = await streamExplain(
        post.prompt,
        post.intent,
        post.summaryStats,
        signal,
        'full'
      )
      if (signal.aborted) return
      patchPost(postId, { status: 'done', fullText, isExpanded: true })
    } catch (err) {
      if (err.name === 'AbortError') return
      patchPost(postId, { status: 'done' }) // revert â€” short text still visible
    } finally {
      if (mountedRef.current) setActivePostId(null)
    }
  }, [getPost, patchPost])
```

**Step 4: Export `analyzeDeep` from the return value**

Change the return statement:
```js
  return { analyze, analyzeReply, analyzeDeep, activePostId, cancel }
```

**Step 5: Commit**

```bash
git add src/hooks/useAnalysis.js
git commit -m "feat: two-phase analysis â€” short initial, analyzeDeep on demand"
```

---

### Task 5: Remove `CartesianGrid` from all chart components

**Files:**
- Modify: `src/components/charts/MedianPriceChart.jsx`
- Modify: `src/components/charts/PricePerSqmChart.jsx`
- Modify: `src/components/charts/VolumeChart.jsx`
- Modify: `src/components/charts/ProjectComparisonChart.jsx`

**Context:** Remove `CartesianGrid` import and JSX element from all 4 charts. `VolumeChart` already has `vertical={false}` but we remove it entirely.

**Step 1: `MedianPriceChart.jsx`**

Remove `CartesianGrid` from the import line:
```js
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts'
```
Remove the `<CartesianGrid strokeDasharray="3 3" stroke="#1e293b" />` JSX line.

**Step 2: `PricePerSqmChart.jsx`**

Remove `CartesianGrid` from import:
```js
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts'
```
Remove the `<CartesianGrid strokeDasharray="3 3" stroke="#1e293b" />` JSX line.

**Step 3: `VolumeChart.jsx`**

Remove `CartesianGrid` from import:
```js
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts'
```
Remove the `<CartesianGrid strokeDasharray="3 3" stroke="#1e293b" vertical={false} />` JSX line.

**Step 4: `ProjectComparisonChart.jsx`**

Remove `CartesianGrid` from import:
```js
import { LineChart, Line, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer } from 'recharts'
```
Remove the `<CartesianGrid strokeDasharray="3 3" stroke="#1e293b" />` JSX line.

**Step 5: Commit**

```bash
git add src/components/charts/MedianPriceChart.jsx src/components/charts/PricePerSqmChart.jsx src/components/charts/VolumeChart.jsx src/components/charts/ProjectComparisonChart.jsx
git commit -m "style: remove CartesianGrid from all charts for cleaner look"
```

---

### Task 6: `MedianPriceChart` + `PricePerSqmChart` â€” Bar/Line switching

**Files:**
- Modify: `src/components/charts/MedianPriceChart.jsx`
- Modify: `src/components/charts/PricePerSqmChart.jsx`

**Context:** Both charts currently render `LineChart`/`Line`. They need to accept a `chartType` prop (`'bar'` | `'line'`) and render either `BarChart`/`Bar` or `LineChart`/`Line` accordingly. Default to `'bar'`.

**Step 1: Update `MedianPriceChart.jsx`**

Full replacement:

```jsx
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts'
import { ChartCard } from './ChartCard'

const fmt = (v) => v >= 1_000_000 ? `${(v / 1_000_000).toFixed(1)}M` : `${(v / 1_000).toFixed(0)}K`

const CustomTooltip = ({ active, payload, label }) => {
  if (!active || !payload?.length) return null
  return (
    <div className="border rounded px-3 py-2 text-xs" style={{ backgroundColor: 'var(--tooltip-bg)', borderColor: 'var(--tooltip-border)', color: 'var(--tooltip-color)' }}>
      <p className="text-slate-400 mb-1">{label}</p>
      <p className="font-medium">AED {Number(payload[0]?.value).toLocaleString()}</p>
      <p className="text-slate-500">{payload[0]?.payload?.tx_count?.toLocaleString()} transactions</p>
    </div>
  )
}

export function MedianPriceChart({ data, chartType = 'bar' }) {
  const commonProps = {
    data,
    margin: { top: 4, right: 8, left: 0, bottom: 0 },
  }
  const xAxis = <XAxis dataKey="month" tick={{ fontSize: 10, fill: '#64748b' }} tickLine={false} interval="preserveStartEnd" />
  const yAxis = <YAxis tickFormatter={fmt} tick={{ fontSize: 10, fill: '#64748b' }} tickLine={false} axisLine={false} width={48} />
  const tooltip = <Tooltip content={<CustomTooltip />} />

  return (
    <ChartCard title="Median Sale Price" subtitle="Monthly median Â· AED" empty={!data?.length}>
      <ResponsiveContainer width="100%" height={220}>
        {chartType === 'bar' ? (
          <BarChart {...commonProps}>
            {xAxis}{yAxis}{tooltip}
            <Bar dataKey="median_price" fill="#e94560" radius={[2, 2, 0, 0]} maxBarSize={20} />
          </BarChart>
        ) : (
          <LineChart {...commonProps}>
            {xAxis}{yAxis}{tooltip}
            <Line type="monotone" dataKey="median_price" stroke="#e94560" strokeWidth={2} dot={false} activeDot={{ r: 4, fill: '#e94560' }} />
          </LineChart>
        )}
      </ResponsiveContainer>
    </ChartCard>
  )
}
```

**Step 2: Update `PricePerSqmChart.jsx`**

Full replacement:

```jsx
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts'
import { ChartCard } from './ChartCard'

const fmt = (v) => `${(v / 1_000).toFixed(0)}K`

const CustomTooltip = ({ active, payload, label }) => {
  if (!active || !payload?.length) return null
  return (
    <div className="border rounded px-3 py-2 text-xs" style={{ backgroundColor: 'var(--tooltip-bg)', borderColor: 'var(--tooltip-border)', color: 'var(--tooltip-color)' }}>
      <p className="text-slate-400 mb-1">{label}</p>
      <p className="font-medium">AED {Number(payload[0]?.value).toLocaleString()} / sqm</p>
      <p className="text-slate-500">{payload[0]?.payload?.tx_count?.toLocaleString()} transactions</p>
    </div>
  )
}

export function PricePerSqmChart({ data, chartType = 'bar' }) {
  const commonProps = {
    data,
    margin: { top: 4, right: 8, left: 0, bottom: 0 },
  }
  const xAxis = <XAxis dataKey="month" tick={{ fontSize: 10, fill: '#64748b' }} tickLine={false} interval="preserveStartEnd" />
  const yAxis = <YAxis tickFormatter={fmt} tick={{ fontSize: 10, fill: '#64748b' }} tickLine={false} axisLine={false} width={48} />
  const tooltip = <Tooltip content={<CustomTooltip />} />

  return (
    <ChartCard title="Price per SQM" subtitle="Monthly median Â· AED/sqm" empty={!data?.length}>
      <ResponsiveContainer width="100%" height={220}>
        {chartType === 'bar' ? (
          <BarChart {...commonProps}>
            {xAxis}{yAxis}{tooltip}
            <Bar dataKey="median_rate" fill="#38bdf8" radius={[2, 2, 0, 0]} maxBarSize={20} />
          </BarChart>
        ) : (
          <LineChart {...commonProps}>
            {xAxis}{yAxis}{tooltip}
            <Line type="monotone" dataKey="median_rate" stroke="#38bdf8" strokeWidth={2} dot={false} activeDot={{ r: 4, fill: '#38bdf8' }} />
          </LineChart>
        )}
      </ResponsiveContainer>
    </ChartCard>
  )
}
```

**Step 3: Commit**

```bash
git add src/components/charts/MedianPriceChart.jsx src/components/charts/PricePerSqmChart.jsx
git commit -m "feat: add bar/line switching to MedianPriceChart and PricePerSqmChart"
```

---

### Task 7: `ProjectComparisonChart` â€” Bar/Line switching

**Files:**
- Modify: `src/components/charts/ProjectComparisonChart.jsx`

**Context:** Currently always renders `LineChart`. Add `chartType` prop.

**Step 1: Update `ProjectComparisonChart.jsx`**

Full replacement:

```jsx
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer } from 'recharts'
import { ChartCard } from './ChartCard'

const COLORS = ['#e94560','#38bdf8','#a78bfa','#34d399','#fb923c','#f472b6','#facc15','#60a5fa']

const fmt = (v) => v >= 1_000_000 ? `${(v / 1_000_000).toFixed(1)}M` : `${(v / 1_000).toFixed(0)}K`

export function ProjectComparisonChart({ data, seriesKeys = [], chartType = 'bar' }) {
  const isEmpty = !data || !Array.isArray(data) || data.length === 0 || !seriesKeys.length

  const commonProps = {
    data,
    margin: { top: 4, right: 8, left: 0, bottom: 0 },
  }
  const xAxis = <XAxis dataKey="month" tick={{ fontSize: 10, fill: '#64748b' }} tickLine={false} interval="preserveStartEnd" />
  const yAxis = <YAxis tickFormatter={fmt} tick={{ fontSize: 10, fill: '#64748b' }} tickLine={false} axisLine={false} width={48} />
  const tooltip = (
    <Tooltip
      formatter={(value, name) => [`AED ${Number(value).toLocaleString()}`, name]}
      contentStyle={{ backgroundColor: 'var(--tooltip-bg)', border: '1px solid var(--tooltip-border)', borderRadius: 6, fontSize: 11, color: 'var(--tooltip-color)' }}
      labelStyle={{ color: '#94a3b8', marginBottom: 4 }}
    />
  )
  const legend = <Legend wrapperStyle={{ fontSize: 11, color: '#94a3b8' }} />

  return (
    <ChartCard
      title="Project Comparison"
      subtitle={
        seriesKeys.length
          ? `Median price Â· ${seriesKeys.length} project${seriesKeys.length > 1 ? 's' : ''}`
          : 'Select projects above to compare'
      }
      empty={isEmpty}
    >
      <ResponsiveContainer width="100%" height={260}>
        {chartType === 'bar' ? (
          <BarChart {...commonProps}>
            {xAxis}{yAxis}{tooltip}{legend}
            {seriesKeys.map((project, i) => (
              <Bar key={project} dataKey={project} fill={COLORS[i % COLORS.length]} radius={[2, 2, 0, 0]} maxBarSize={16} />
            ))}
          </BarChart>
        ) : (
          <LineChart {...commonProps}>
            {xAxis}{yAxis}{tooltip}{legend}
            {seriesKeys.map((project, i) => (
              <Line
                key={project}
                type="monotone"
                dataKey={project}
                stroke={COLORS[i % COLORS.length]}
                strokeWidth={2}
                dot={false}
                activeDot={{ r: 4 }}
                connectNulls
              />
            ))}
          </LineChart>
        )}
      </ResponsiveContainer>
    </ChartCard>
  )
}
```

**Step 2: Commit**

```bash
git add src/components/charts/ProjectComparisonChart.jsx
git commit -m "feat: add bar/line switching to ProjectComparisonChart"
```

---

### Task 8: `DynamicChart` â€” Accept and pass `chartType`

**Files:**
- Modify: `src/components/charts/DynamicChart.jsx`

**Context:** `DynamicChart` is the router that picks which chart component to render. It needs to accept `chartType` and forward it to the relevant charts. `VolumeChart` is always bar (counts), so skip passing chartType there.

**Step 1: Update `DynamicChart.jsx`**

Full replacement:

```jsx
import { MedianPriceChart }       from './MedianPriceChart'
import { PricePerSqmChart }       from './PricePerSqmChart'
import { VolumeChart }            from './VolumeChart'
import { ProjectComparisonChart } from './ProjectComparisonChart'

/**
 * Renders the correct chart component based on the post's queryType.
 * chartType ('bar' | 'line') is forwarded to trend/comparison charts.
 * VolumeChart is always bar (transaction counts).
 */
export function DynamicChart({ intent, chartData, chartKeys, chartType = 'bar' }) {
  const { queryType } = intent ?? {}

  if (queryType === 'rate_trend') {
    return <PricePerSqmChart data={chartData} chartType={chartType} />
  }
  if (queryType === 'volume_trend') {
    return <VolumeChart data={chartData} />
  }
  if (['project_comparison', 'district_comparison', 'layout_distribution'].includes(queryType)) {
    return <ProjectComparisonChart data={chartData} seriesKeys={chartKeys} chartType={chartType} />
  }
  // Default: price_trend and anything else
  return <MedianPriceChart data={chartData} chartType={chartType} />
}
```

**Step 2: Commit**

```bash
git add src/components/charts/DynamicChart.jsx
git commit -m "feat: pass chartType through DynamicChart to child charts"
```

---

### Task 9: `PlusMenu` â€” Add Chart Type toggle

**Files:**
- Modify: `src/components/PlusMenu.jsx`

**Context:** Add a "Chart Type" section below the existing Date Range section. Two buttons: **Bar** and **Line**. Reads/writes `settings.chartType` via `onSettingsChange`.

**Step 1: Update `PlusMenu.jsx`**

Add the chart type section inside the popover `<div>`, after the Date Range section:

```jsx
          {/* Chart Type */}
          <div>
            <p className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1.5">
              <span>ðŸ“Š</span> Chart Type
            </p>
            <div className="flex gap-1">
              {['bar', 'line'].map(type => (
                <button
                  key={type}
                  type="button"
                  onClick={() => onSettingsChange({ chartType: type })}
                  className={`flex-1 py-1.5 rounded-lg text-xs font-medium capitalize transition-colors ${
                    settings.chartType === type
                      ? 'bg-accent text-white'
                      : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  {type}
                </button>
              ))}
            </div>
          </div>
```

**Step 2: Commit**

```bash
git add src/components/PlusMenu.jsx
git commit -m "feat: add chart type toggle (bar/line) to PlusMenu"
```

---

### Task 10: `PostCard` â€” Deeper analysis link + InlineDateRange + remove delete button

**Files:**
- Modify: `src/components/PostCard.jsx`

**Context:** This is the biggest UI change. Three sub-tasks:
1. Remove the delete button (the `onRemove && isDone` block)
2. Add "Deeper analysis" link below `analysisText`
3. Add `InlineDateRange` above the chart, filter `chartData` client-side in local state
4. Pass `chartType` to `DynamicChart`

**Step 1: Add imports**

Add `InlineDateRange` import at the top:
```jsx
import { InlineDateRange } from './charts/InlineDateRange'
```

**Step 2: Update `PostCard` signature to accept new props**

Change:
```jsx
export function PostCard({ post, onRemove, onReply, isActive, onCancel }) {
```
To:
```jsx
export function PostCard({ post, onReply, isActive, onCancel, onDeepAnalysis, chartType = 'bar' }) {
```

**Step 3: Add local state for date range + chart data filtering**

Add after existing `const [copied, setCopied] = useState(false)`:
```jsx
  const [dateRange, setDateRange] = useState({ dateFrom: '', dateTo: '' })

  // Filter chartData by local dateRange selection (client-side, no re-query)
  const filteredChartData = (() => {
    const data = post.chartData
    if (!data?.length) return data
    const { dateFrom, dateTo } = dateRange
    if (!dateFrom && !dateTo) return data
    return data.filter(row => {
      const m = row.month ?? ''
      if (dateFrom && m < dateFrom) return false
      if (dateTo   && m > dateTo)   return false
      return true
    })
  })()
```

**Step 4: Remove the delete button block**

Remove this entire block from PostCard:
```jsx
          {onRemove && isDone && (
            <button
              onClick={() => onRemove(post.id)}
              className="rounded-lg p-1.5 text-slate-600 hover:bg-slate-700 hover:text-slate-300 transition-colors"
              title="Remove post"
            >
              <svg className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          )}
```

**Step 5: Add "Deeper analysis" link below analysisText**

Replace the analysis text block:
```jsx
          {post.analysisText ? (
            <div className="text-sm text-slate-700 dark:text-slate-300 leading-relaxed space-y-3 whitespace-pre-wrap">
              {post.analysisText}
            </div>
          ) : (
            !isStreaming && <p className="text-sm text-slate-500 italic">No analysis available.</p>
          )}
```

With:
```jsx
          {post.analysisText ? (
            <>
              <div className="text-sm text-slate-700 dark:text-slate-300 leading-relaxed whitespace-pre-wrap">
                {post.isExpanded && post.fullText ? post.fullText : post.analysisText}
              </div>

              {/* Deeper analysis link */}
              {isDone && onDeepAnalysis && (
                <button
                  onClick={() => onDeepAnalysis(post.id)}
                  disabled={post.status === 'deepening'}
                  className="flex items-center gap-1 text-xs text-slate-400 dark:text-slate-500 hover:text-accent dark:hover:text-accent transition-colors disabled:opacity-40 mt-1"
                >
                  {post.status === 'deepening' ? (
                    <>
                      <svg className="h-3 w-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v3m0 12v3M3 12h3m12 0h3"/>
                      </svg>
                      Loading deeper analysisâ€¦
                    </>
                  ) : post.isExpanded ? (
                    <>
                      <svg className="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M5 15l7-7 7 7"/>
                      </svg>
                      Less
                    </>
                  ) : (
                    <>
                      <svg className="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7"/>
                      </svg>
                      Deeper analysis
                    </>
                  )}
                </button>
              )}
            </>
          ) : (
            !isStreaming && <p className="text-sm text-slate-500 italic">No analysis available.</p>
          )}
```

**Step 6: Add `InlineDateRange` above the chart and use `filteredChartData`**

Replace the chart block:
```jsx
          {post.chartData?.length > 0 && (
            <div className="mt-2">
              <DynamicChart
                intent={post.intent}
                chartData={post.chartData}
                chartKeys={post.chartKeys}
              />
            </div>
          )}
```

With:
```jsx
          {post.chartData?.length > 0 && (
            <div className="mt-2 space-y-2">
              <div className="flex justify-end">
                <InlineDateRange value={dateRange} onChange={setDateRange} />
              </div>
              <DynamicChart
                intent={post.intent}
                chartData={filteredChartData}
                chartKeys={post.chartKeys}
                chartType={chartType}
              />
            </div>
          )}
```

**Step 7: Update `analyzeDeep` context note in `ReplyCard`**

`ReplyCard` uses `reply.analysisText` â€” no change needed since replies don't get the two-phase treatment.

**Step 8: Commit**

```bash
git add src/components/PostCard.jsx
git commit -m "feat: deeper analysis link, per-post date range, remove delete button"
```

---

### Task 11: `PostFeed` â€” Remove `onRemove`, add `onDeepAnalysis` + `chartType`

**Files:**
- Modify: `src/components/PostFeed.jsx`

**Context:** Remove `onRemove` prop (no longer needed). Add `onDeepAnalysis` and `chartType` pass-through to `PostCard`.

**Step 1: Update `PostFeed.jsx`**

Full replacement:

```jsx
import { PostCard } from './PostCard'

export function PostFeed({ posts, onReply, activePostId, onCancel, onDeepAnalysis, chartType }) {
  if (!posts.length) {
    return (
      <div className="py-16 text-center space-y-2">
        <p className="text-slate-400 dark:text-slate-500 text-sm">No analyses yet.</p>
        <p className="text-slate-400 dark:text-slate-600 text-xs">Pick a topic or type your own question below.</p>
      </div>
    )
  }

  return (
    <div className="space-y-4">
      {posts.map(post => (
        <PostCard
          key={post.id}
          post={post}
          onReply={onReply}
          isActive={post.id === activePostId}
          onCancel={onCancel}
          onDeepAnalysis={onDeepAnalysis}
          chartType={chartType}
        />
      ))}
    </div>
  )
}
```

**Step 2: Commit**

```bash
git add src/components/PostFeed.jsx
git commit -m "refactor: remove onRemove from PostFeed, add onDeepAnalysis + chartType"
```

---

### Task 12: `App.jsx` â€” Floating input bar + wire `analyzeDeep` + pass `chartType`

**Files:**
- Modify: `src/App.jsx`

**Context:** Three changes:
1. Remove `border-t`, `bg-white/80`, `backdrop-blur` from the bottom bar wrapper
2. Destructure `analyzeDeep` from `useAnalysis`
3. Pass `onDeepAnalysis` and `chartType` to `PostFeed`
4. Remove `onRemove={removePost}` from `PostFeed`

**Step 1: Destructure `analyzeDeep` from `useAnalysis`**

Change:
```jsx
  const { analyze, analyzeReply, activePostId, cancel } = useAnalysis(meta, {
```
To:
```jsx
  const { analyze, analyzeReply, analyzeDeep, activePostId, cancel } = useAnalysis(meta, {
```

**Step 2: Remove the bottom bar background/border**

Change:
```jsx
          <div className="shrink-0 border-t border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-[#0f172a]/95 backdrop-blur px-4 py-3 z-10">
```
To:
```jsx
          <div className="shrink-0 px-4 py-3 z-10">
```

**Step 3: Update `PostFeed` call â€” remove `onRemove`, add `onDeepAnalysis` + `chartType`**

Change:
```jsx
              <PostFeed
                posts={posts}
                onRemove={removePost}
                onReply={(postId, prompt) => analyzeReply(postId, prompt + getDateRangeHint())}
                activePostId={activePostId}
                onCancel={cancel}
              />
```
To:
```jsx
              <PostFeed
                posts={posts}
                onReply={(postId, prompt) => analyzeReply(postId, prompt + getDateRangeHint())}
                activePostId={activePostId}
                onCancel={cancel}
                onDeepAnalysis={analyzeDeep}
                chartType={settings.chartType}
              />
```

**Step 4: Commit**

```bash
git add src/App.jsx
git commit -m "feat: floating input bar, wire analyzeDeep, pass chartType to feed"
```

---

### Task 13: `ReplyInput` â€” Fix font size and icon

**Files:**
- Modify: `src/components/PostCard.jsx` (ReplyInput is defined inline)

**Context:** The `ReplyInput` function component lives inside `PostCard.jsx`. Change:
- Collapsed button: `text-xs` â†’ `text-sm`; replace `â†³` text with a chat bubble SVG icon
- Expanded textarea: `text-xs` â†’ `text-sm`
- Submit button: `text-xs` â†’ `text-sm`

**Step 1: Update the collapsed state of `ReplyInput`**

Change:
```jsx
    return (
      <button
        onClick={() => setOpen(true)}
        disabled={disabled}
        className="text-xs text-slate-500 hover:text-slate-300 transition-colors flex items-center gap-1 disabled:opacity-30 disabled:cursor-not-allowed"
      >
        <span>â†³</span> Ask a follow-up
      </button>
    )
```
To:
```jsx
    return (
      <button
        onClick={() => setOpen(true)}
        disabled={disabled}
        className="text-sm text-slate-500 hover:text-slate-300 transition-colors flex items-center gap-1.5 disabled:opacity-30 disabled:cursor-not-allowed"
      >
        <svg className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path strokeLinecap="round" strokeLinejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        Ask a follow-up
      </button>
    )
```

**Step 2: Update the expanded textarea font size**

Change the textarea className from `text-xs` to `text-sm`:
```jsx
        className="flex-1 resize-none bg-transparent border-b border-slate-600 text-sm text-slate-200 placeholder-slate-600 focus:outline-none focus:border-slate-400 py-1"
```

Change the submit button className from `text-xs` to `text-sm`:
```jsx
        className="text-sm text-accent disabled:opacity-30 pb-1 hover:opacity-80 transition-opacity"
```

**Step 3: Run all tests**

```bash
cd /Users/nagi/abudhabi-sales-explorer && npx vitest run
```

Expected: All tests pass. If any fail, fix before proceeding.

**Step 4: Commit**

```bash
git add src/components/PostCard.jsx
git commit -m "style: fix ReplyInput â€” bigger font, chat bubble icon"
```

---

## Final Verification

```bash
cd /Users/nagi/abudhabi-sales-explorer && npx vitest run
```

All tests should pass. Then start the dev server and manually verify:
- [ ] Input bar has no background/border â€” floats over content
- [ ] Initial analysis is 2-3 sentences
- [ ] "Deeper analysis" link appears â†’ click shows full analysis â†’ click "Less" collapses
- [ ] Charts render as bar by default
- [ ] PlusMenu chart type toggle switches bar â†” line across all posts
- [ ] No grid lines in any chart
- [ ] Date range inputs appear above each chart â†’ filtering slices the data
- [ ] No delete X button on posts
- [ ] "Ask a follow-up" has chat icon, readable font size
