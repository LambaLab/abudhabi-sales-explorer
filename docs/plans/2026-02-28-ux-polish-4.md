# UX Polish 4 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Six UX improvements: global cursor pointer, fully-round pill inputs, click-away to close reply input, AI clarification instead of red errors, elegant + menu redesign, and a react-day-picker date range component.

**Architecture:** Mostly targeted file edits. The biggest new surface is `DateRangePickerPopover.jsx` (new component using `react-day-picker` v9 with Tailwind classNames). The clarify mode adds one branch to `api/explain.js` and replaces two `catch` blocks in `useAnalysis.js`. Everything else is CSS/layout changes.

**Tech Stack:** React 19, Tailwind CSS v4, Vite, `react-day-picker` v9, `date-fns` v4 (already installed), Vitest.

---

### Task 1: Global cursor pointer

**Files:**
- Modify: `src/index.css`

**Step 1: Add the CSS rule**

Open `src/index.css`. After the closing `}` of the `body` block (around line 15), add:

```css
button, a, select, [role="button"] {
  cursor: pointer;
}
```

Full file after change:
```css
@import "tailwindcss";

/* Enable class-based dark mode: add `dark` class to <html> to activate */
@custom-variant dark (&:where(.dark, .dark *));

@theme {
  --color-brand: #1a1a2e;
  --color-accent: #9266cc;
}

body {
  background-color: #f8fafc;
  color: #0f172a;
  font-family: 'Inter', system-ui, sans-serif;
}

button, a, select, [role="button"] {
  cursor: pointer;
}

.dark body {
  background-color: #0f0f23;
  color: #e2e8f0;
}
/* ... rest of file unchanged */
```

**Step 2: Run tests**

```bash
node ./node_modules/.bin/vitest run
```
Expected: 67 tests pass.

**Step 3: Commit**

```bash
git add src/index.css
git commit -m "feat: add global cursor pointer for interactive elements"
```

---

### Task 2: Fully-round pill inputs

**Files:**
- Modify: `src/components/ChatInput.jsx` (1 class change)
- Modify: `src/components/PostCard.jsx` (1 class change in ReplyInput)

**Step 1: ChatInput â€” change `rounded-2xl` to `rounded-full`**

In `src/components/ChatInput.jsx`, find the `<form>` opening tag (line ~39). Change `rounded-2xl` to `rounded-full`:

```jsx
/* BEFORE */
className="relative flex items-center rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/60 shadow-sm focus-within:border-accent focus-within:ring-2 focus-within:ring-accent/20 transition-colors"

/* AFTER */
className="relative flex items-center rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/60 shadow-sm focus-within:border-accent focus-within:ring-2 focus-within:ring-accent/20 transition-colors"
```

**Step 2: ReplyInput â€” change `rounded-2xl` to `rounded-full`**

In `src/components/PostCard.jsx`, find the `<form>` inside `ReplyInput` (line ~65). Change `rounded-2xl` to `rounded-full`:

```jsx
/* BEFORE */
className="flex items-center gap-2 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/60 shadow-sm px-3 focus-within:border-accent focus-within:ring-2 focus-within:ring-accent/20 transition-colors"

/* AFTER */
className="flex items-center gap-2 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/60 shadow-sm px-3 focus-within:border-accent focus-within:ring-2 focus-within:ring-accent/20 transition-colors"
```

**Step 3: Run tests**

```bash
node ./node_modules/.bin/vitest run
```
Expected: 67 tests pass.

**Step 4: Commit**

```bash
git add src/components/ChatInput.jsx src/components/PostCard.jsx
git commit -m "feat: make ChatInput and ReplyInput fully-round pills"
```

---

### Task 3: Click-away to close ReplyInput

**Files:**
- Modify: `src/components/PostCard.jsx` â€” `ReplyInput` function (lines 29â€“93)

**Step 1: Add wrapperRef and click-outside effect**

Open `src/components/PostCard.jsx`. Inside `ReplyInput`, add a `wrapperRef` and click-outside listener. Replace the entire `ReplyInput` function with:

```jsx
/** Inline follow-up input that lives at the bottom of each PostCard */
function ReplyInput({ postId, onSubmit, disabled }) {
  const [open, setOpen]   = useState(false)
  const [value, setValue] = useState('')
  const textareaRef  = useRef(null)
  const wrapperRef   = useRef(null)

  useEffect(() => {
    if (open) textareaRef.current?.focus()
  }, [open])

  // Collapse when clicking outside the expanded form
  useEffect(() => {
    if (!open) return
    function onDown(e) {
      if (!wrapperRef.current?.contains(e.target)) {
        setOpen(false)
        setValue('')
      }
    }
    document.addEventListener('mousedown', onDown)
    return () => document.removeEventListener('mousedown', onDown)
  }, [open])

  function handleSubmit(e) {
    e.preventDefault()
    const trimmed = value.trim()
    if (!trimmed || disabled) return
    onSubmit(postId, trimmed)
    setValue('')
    setOpen(false)
  }

  if (!open) {
    return (
      <button
        onClick={() => setOpen(true)}
        disabled={disabled}
        className="text-sm text-slate-400 dark:text-slate-500 hover:text-accent dark:hover:text-accent transition-colors flex items-center gap-1.5 disabled:opacity-30 disabled:cursor-not-allowed"
      >
        <svg className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path strokeLinecap="round" strokeLinejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        Ask a follow-up
      </button>
    )
  }

  return (
    <div ref={wrapperRef}>
      <form
        onSubmit={handleSubmit}
        className="flex items-center gap-2 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/60 shadow-sm px-3 focus-within:border-accent focus-within:ring-2 focus-within:ring-accent/20 transition-colors"
      >
        <textarea
          ref={textareaRef}
          value={value}
          onChange={e => setValue(e.target.value)}
          onKeyDown={e => {
            if (e.key === 'Enter' && !e.shiftKey) handleSubmit(e)
            if (e.key === 'Escape') { setOpen(false); setValue('') }
          }}
          placeholder="Ask a follow-upâ€¦"
          rows={1}
          disabled={disabled}
          style={{ resize: 'none', minHeight: '44px', maxHeight: '120px', overflowY: 'auto' }}
          className="flex-1 bg-transparent py-3 text-sm text-slate-900 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none disabled:opacity-50"
        />
        <button
          type="submit"
          disabled={!value.trim() || disabled}
          className="shrink-0 my-2 mr-1 flex h-8 w-8 items-center justify-center rounded-xl bg-accent text-white disabled:opacity-30 hover:opacity-80 transition-opacity"
          aria-label="Submit follow-up"
        >
          <svg className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
            <path strokeLinecap="round" strokeLinejoin="round" d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
      </form>
    </div>
  )
}
```

Key changes: added `wrapperRef`, added click-outside `useEffect`, wrapped the expanded `<form>` in `<div ref={wrapperRef}>`.

**Step 2: Run tests**

```bash
node ./node_modules/.bin/vitest run
```
Expected: 67 tests pass.

**Step 3: Commit**

```bash
git add src/components/PostCard.jsx
git commit -m "feat: collapse ReplyInput when clicking outside"
```

---

### Task 4: AI clarification instead of red error messages

**Files:**
- Modify: `api/explain.js`
- Modify: `src/hooks/useAnalysis.js`

**Step 1: Add clarify mode to `api/explain.js`**

Open `api/explain.js`. Make three changes:

**Change A** â€” Add `CLARIFY_PROMPT` constant after `FULL_PROMPT` (around line 23):

```js
const CLARIFY_PROMPT = `You are a friendly real estate data assistant for the Abu Dhabi property market.
The user asked a question that couldn't be processed. Respond in 2-3 sentences:
1. Acknowledge warmly that you couldn't find what they were looking for (never mention SQL, databases, or technical errors).
2. State your best interpretation of what they were asking about.
3. Ask ONE specific, helpful clarifying question.
Be conversational, warm, and concise. No lists, no headers, no markdown.`
```

**Change B** â€” Relax the validation check (line ~94) to allow `intent` to be null for clarify mode:

```js
/* BEFORE */
if (!prompt || !intent || !summaryStats) {
  return new Response(JSON.stringify({ error: 'Missing required fields: prompt, intent, summaryStats' }), { status: 400, headers: { 'Content-Type': 'application/json' } })
}

/* AFTER */
if (!prompt) {
  return new Response(JSON.stringify({ error: 'Missing required field: prompt' }), { status: 400, headers: { 'Content-Type': 'application/json' } })
}
if (mode !== 'clarify' && (!intent || !summaryStats)) {
  return new Response(JSON.stringify({ error: 'Missing required fields: intent, summaryStats' }), { status: 400, headers: { 'Content-Type': 'application/json' } })
}
```

**Change C** â€” Add clarify branch before the `systemPrompt` selection (around line 98):

```js
/* BEFORE */
const systemPrompt = mode === 'short' ? SHORT_PROMPT : FULL_PROMPT
const maxTokens    = mode === 'short' ? 150 : 600

const userMessage = `Original question: "${prompt}"
...`

/* AFTER */
if (mode === 'clarify') {
  const stream = anthropic.messages.stream({
    model: 'claude-haiku-4-5',
    max_tokens: 120,
    system: CLARIFY_PROMPT,
    messages: [{ role: 'user', content: `The user asked: "${prompt}"\n\nGenerate a friendly clarifying response.` }],
  })

  const readable = new ReadableStream({
    async start(controller) {
      try {
        for await (const chunk of stream) {
          if (chunk.type === 'content_block_delta' && chunk.delta?.type === 'text_delta') {
            controller.enqueue(new TextEncoder().encode(chunk.delta.text))
          }
        }
        controller.close()
      } catch (err) {
        controller.error(err)
      }
    },
  })

  return new Response(readable, {
    headers: { 'Content-Type': 'text/plain; charset=utf-8' },
  })
}

const systemPrompt = mode === 'short' ? SHORT_PROMPT : FULL_PROMPT
const maxTokens    = mode === 'short' ? 150 : 600

const userMessage = `Original question: "${prompt}"
...` // rest unchanged
```

**Step 2: Update error catch in `useAnalysis.js` â€” `analyze` function**

Open `src/hooks/useAnalysis.js`. Find the `catch` block of the `analyze` function (around line 134):

```js
/* BEFORE */
} catch (err) {
  if (err.name === 'AbortError') return
  patchPost(postId, { status: 'error', error: err.message ?? 'Something went wrong' })
  if (mountedRef.current) setActivePostId(null)
}

/* AFTER */
} catch (err) {
  if (err.name === 'AbortError') return
  // Instead of red error text, ask Claude to clarify
  try {
    const clarifyText = await streamExplain(prompt, null, {}, signal, 'clarify')
    if (!signal.aborted) {
      patchPost(postId, { status: 'done', analysisText: clarifyText, shortText: clarifyText })
    }
  } catch {
    patchPost(postId, {
      status: 'done',
      analysisText: "I had trouble understanding that query. Could you try rephrasing it?",
      shortText: "I had trouble understanding that query. Could you try rephrasing it?",
    })
  }
  if (mountedRef.current) setActivePostId(null)
}
```

**Step 3: Update error catch in `useAnalysis.js` â€” `analyzeReply` function**

Find the `catch` block of the `analyzeReply` function (around line 255):

```js
/* BEFORE */
} catch (err) {
  if (err.name === 'AbortError') {
    patchReply(postId, replyId, { status: 'error', error: 'Interrupted' })
    return
  }
  patchReply(postId, replyId, { status: 'error', error: err.message ?? 'Something went wrong' })
  if (mountedRef.current) setActivePostId(null)
}

/* AFTER */
} catch (err) {
  if (err.name === 'AbortError') {
    patchReply(postId, replyId, { status: 'error', error: 'Interrupted' })
    return
  }
  // Instead of red error text, ask Claude to clarify
  try {
    const clarifyText = await streamExplain(prompt, null, {}, signal, 'clarify')
    if (!signal.aborted) {
      patchReply(postId, replyId, { status: 'done', analysisText: clarifyText })
    }
  } catch {
    patchReply(postId, replyId, {
      status: 'done',
      analysisText: "I had trouble with that question. Could you rephrase it?",
    })
  }
  if (mountedRef.current) setActivePostId(null)
}
```

**Step 4: Run tests**

```bash
node ./node_modules/.bin/vitest run
```
Expected: 67 tests pass.

**Step 5: Commit**

```bash
git add api/explain.js src/hooks/useAnalysis.js
git commit -m "feat: replace error state with AI clarification question"
```

---

### Task 5: Install react-day-picker and build DateRangePickerPopover

**Files:**
- Modify: `package.json` (via npm install)
- Create: `src/components/DateRangePickerPopover.jsx`

**Step 1: Install react-day-picker v9**

```bash
npm install react-day-picker@^9
```

Expected: `package.json` updated with `"react-day-picker": "^9.x.x"` in dependencies.

**Step 2: Create `src/components/DateRangePickerPopover.jsx`**

Create the file with this complete implementation:

```jsx
import { useState, useRef, useEffect } from 'react'
import { DayPicker } from 'react-day-picker'
import {
  format, subDays, subMonths, subYears,
  startOfMonth, endOfMonth,
  startOfQuarter, endOfQuarter, subQuarters,
  startOfYear, endOfYear,
} from 'date-fns'

/** Convert a Date to 'YYYY-MM' string */
function toYM(d) {
  if (!d) return ''
  return format(d, 'yyyy-MM')
}

/** Convert 'YYYY-MM' string to a Date (first day of that month) */
function fromYM(s) {
  if (!s) return undefined
  const [y, m] = s.split('-').map(Number)
  return new Date(y, m - 1, 1)
}

const PRESETS = [
  { label: 'Last 30 days',   fn: () => ({ from: subDays(new Date(), 30), to: new Date() }) },
  { label: 'Last month',     fn: () => ({ from: startOfMonth(subMonths(new Date(), 1)), to: endOfMonth(subMonths(new Date(), 1)) }) },
  { label: 'Last 90 days',   fn: () => ({ from: subDays(new Date(), 90), to: new Date() }) },
  { label: 'Last quarter',   fn: () => ({ from: startOfQuarter(subQuarters(new Date(), 1)), to: endOfQuarter(subQuarters(new Date(), 1)) }) },
  { label: 'Last 12 months', fn: () => ({ from: subMonths(new Date(), 12), to: new Date() }) },
  { label: 'Last year',      fn: () => ({ from: startOfYear(subYears(new Date(), 1)), to: endOfYear(subYears(new Date(), 1)) }) },
]

/** Return the display label for a date range, matching a preset if possible */
export function getDateRangeLabel(dateFrom, dateTo) {
  if (!dateFrom && !dateTo) return 'All time'
  for (const p of PRESETS) {
    const r = p.fn()
    if (toYM(r.from) === dateFrom && toYM(r.to) === dateTo) return p.label
  }
  if (dateFrom && dateTo) return `${dateFrom} â€“ ${dateTo}`
  if (dateFrom) return `From ${dateFrom}`
  return 'Custom'
}

/**
 * DateRangePickerPopover
 *
 * Props:
 *   value        { dateFrom: 'YYYY-MM', dateTo: 'YYYY-MM' }
 *   onChange     ({ dateFrom, dateTo }) => void
 *   align        'left' | 'right'  (default 'left') â€” popover horizontal alignment
 */
export function DateRangePickerPopover({ value, onChange, align = 'left' }) {
  const [open, setOpen]   = useState(false)
  const [range, setRange] = useState({ from: fromYM(value?.dateFrom), to: fromYM(value?.dateTo) })
  const [month, setMonth] = useState(fromYM(value?.dateFrom) ?? new Date())
  const popRef   = useRef(null)
  const btnRef   = useRef(null)

  // Sync internal range when value prop changes
  useEffect(() => {
    setRange({ from: fromYM(value?.dateFrom), to: fromYM(value?.dateTo) })
  }, [value?.dateFrom, value?.dateTo])

  // Close on outside click
  useEffect(() => {
    if (!open) return
    function onDown(e) {
      if (!popRef.current?.contains(e.target) && !btnRef.current?.contains(e.target)) {
        setOpen(false)
      }
    }
    document.addEventListener('mousedown', onDown)
    return () => document.removeEventListener('mousedown', onDown)
  }, [open])

  function applyPreset(preset) {
    const r = preset.fn()
    onChange({ dateFrom: toYM(r.from), dateTo: toYM(r.to) })
    setOpen(false)
  }

  function applyRange() {
    onChange({
      dateFrom: toYM(range?.from),
      dateTo:   toYM(range?.to ?? range?.from),
    })
    setOpen(false)
  }

  function handleCancel() {
    setRange({ from: fromYM(value?.dateFrom), to: fromYM(value?.dateTo) })
    setOpen(false)
  }

  const label = getDateRangeLabel(value?.dateFrom, value?.dateTo)
  const isActive = !!(value?.dateFrom || value?.dateTo)

  // Responsive: 1 month on mobile, 2 on sm+
  const numMonths = typeof window !== 'undefined' && window.innerWidth >= 640 ? 2 : 1

  return (
    <div className="relative">
      {/* Trigger button */}
      <button
        ref={btnRef}
        type="button"
        onClick={() => setOpen(o => !o)}
        className={`flex items-center gap-1.5 rounded-full border px-3 py-1.5 text-xs font-medium whitespace-nowrap transition-colors ${
          isActive
            ? 'border-accent text-accent bg-accent/5 dark:bg-accent/10'
            : 'border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-800 hover:border-slate-300 dark:hover:border-slate-600'
        }`}
      >
        <svg className="h-3.5 w-3.5 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        {label}
      </button>

      {/* Popover */}
      {open && (
        <div
          ref={popRef}
          className={`absolute bottom-full mb-2 z-50 flex flex-col sm:flex-row rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-xl overflow-hidden ${
            align === 'right' ? 'right-0' : 'left-0'
          }`}
        >
          {/* Presets panel */}
          <div className="p-3 border-b sm:border-b-0 sm:border-r border-slate-100 dark:border-slate-700 shrink-0 min-w-[160px]">
            <p className="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide px-2 mb-2">Quick select</p>
            <div className="space-y-0.5">
              {PRESETS.map(preset => {
                const r = preset.fn()
                const isActive = toYM(r.from) === value?.dateFrom && toYM(r.to) === value?.dateTo
                return (
                  <button
                    key={preset.label}
                    type="button"
                    onClick={() => applyPreset(preset)}
                    className={`w-full text-left px-3 py-1.5 rounded-lg text-sm transition-colors ${
                      isActive
                        ? 'bg-accent/10 text-accent font-medium'
                        : 'text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700'
                    }`}
                  >
                    {preset.label}
                  </button>
                )
              })}
            </div>
          </div>

          {/* Calendar panel */}
          <div className="p-3 flex flex-col">
            <DayPicker
              mode="range"
              selected={range}
              onSelect={setRange}
              month={month}
              onMonthChange={setMonth}
              numberOfMonths={numMonths}
              showOutsideDays={false}
              classNames={{
                months:        'flex gap-6',
                month:         'min-w-[220px]',
                month_caption: 'flex items-center justify-between mb-3 px-1',
                caption_label: 'text-sm font-semibold text-slate-800 dark:text-slate-200',
                nav:           'flex items-center gap-1',
                button_previous: 'h-7 w-7 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-slate-500 dark:text-slate-400',
                button_next:     'h-7 w-7 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-slate-500 dark:text-slate-400',
                month_grid:    'w-full border-collapse',
                weekdays:      'flex mb-1',
                weekday:       'w-9 text-center text-xs font-medium text-slate-400 dark:text-slate-500',
                week:          'flex mt-1',
                day:           'relative h-9 w-9 text-center p-0',
                day_button:    'h-9 w-9 rounded-full flex items-center justify-center text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors w-full',
                selected:      'bg-accent! text-white! hover:bg-accent! rounded-full',
                today:         'font-bold text-accent',
                outside:       'opacity-0 pointer-events-none',
                disabled:      'opacity-30 cursor-not-allowed',
                range_start:   'bg-accent! text-white! rounded-full',
                range_end:     'bg-accent! text-white! rounded-full',
                range_middle:  'bg-accent/15! text-accent! rounded-none',
                hidden:        'invisible',
              }}
            />

            {/* Apply / Cancel */}
            <div className="flex justify-end gap-2 mt-3 pt-3 border-t border-slate-100 dark:border-slate-700">
              <button
                type="button"
                onClick={handleCancel}
                className="px-4 py-1.5 rounded-lg text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={applyRange}
                disabled={!range?.from}
                className="px-4 py-1.5 rounded-lg text-sm bg-accent text-white disabled:opacity-40 hover:opacity-90 transition-opacity"
              >
                Apply
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
```

**Step 3: Run tests**

```bash
node ./node_modules/.bin/vitest run
```
Expected: 67 tests pass (new component has no test, but nothing should break).

**Step 4: Commit**

```bash
git add package.json package-lock.json src/components/DateRangePickerPopover.jsx
git commit -m "feat: add DateRangePickerPopover with react-day-picker v9"
```

---

### Task 6: Redesign PlusMenu as elegant list popover

**Files:**
- Modify: `src/components/PlusMenu.jsx` (full rewrite)

**Step 1: Rewrite `src/components/PlusMenu.jsx`**

Replace the entire file with:

```jsx
import { useState, useRef, useEffect } from 'react'
import { DateRangePickerPopover, getDateRangeLabel } from './DateRangePickerPopover'

/**
 * Converts settings (defaultDateRange + customFrom/To) to a { dateFrom, dateTo } pair
 * that DateRangePickerPopover understands.
 */
function settingsToRange(settings) {
  if (settings.defaultDateRange === 'all') return { dateFrom: '', dateTo: '' }
  if (settings.defaultDateRange === 'custom') {
    return { dateFrom: settings.customFrom ?? '', dateTo: settings.customTo ?? '' }
  }
  // Legacy preset keys â€” compute dates
  const months = settings.defaultDateRange === '12m' ? 12
               : settings.defaultDateRange === '24m' ? 24 : 12
  const now    = new Date()
  const to     = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`
  const fromD  = new Date(now.getFullYear(), now.getMonth() - months, 1)
  const from   = `${fromD.getFullYear()}-${String(fromD.getMonth() + 1).padStart(2, '0')}`
  return { dateFrom: from, dateTo: to }
}

/**
 * Elegant + menu inside ChatInput pill.
 * Circle button â†’ popover card with Date Range and Chart Type rows.
 */
export function PlusMenu({ settings, onSettingsChange }) {
  const [open, setOpen] = useState(false)
  const ref = useRef(null)

  useEffect(() => {
    if (!open) return
    function onDown(e) {
      if (!ref.current?.contains(e.target)) setOpen(false)
    }
    document.addEventListener('mousedown', onDown)
    return () => document.removeEventListener('mousedown', onDown)
  }, [open])

  const range      = settingsToRange(settings)
  const dateLabel  = getDateRangeLabel(range.dateFrom, range.dateTo)

  function handleDateChange({ dateFrom, dateTo }) {
    onSettingsChange({ defaultDateRange: 'custom', customFrom: dateFrom, customTo: dateTo })
  }

  return (
    <div ref={ref} className="relative shrink-0">
      {/* Circle + button */}
      <button
        type="button"
        onClick={() => setOpen(o => !o)}
        className="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors ml-1"
        title="Options"
        aria-label="Open options menu"
      >
        <svg className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 5v14M5 12h14"/>
        </svg>
      </button>

      {open && (
        <div className="absolute bottom-full left-0 mb-2 w-72 z-30 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg overflow-hidden">

          {/* Row 1 â€” Date Range */}
          <div className="p-2">
            <DateRangePickerPopover
              value={range}
              onChange={handleDateChange}
              trigger={
                <button
                  type="button"
                  className="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors text-left"
                >
                  <span className="flex h-8 w-8 items-center justify-center rounded-lg bg-violet-50 dark:bg-violet-900/30 text-lg shrink-0">
                    ðŸ“…
                  </span>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-slate-800 dark:text-slate-200 leading-none mb-0.5">Date Range</p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 truncate">{dateLabel}</p>
                  </div>
                  <svg className="h-4 w-4 text-slate-300 dark:text-slate-500 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
              }
            />
          </div>

          <div className="mx-4 border-t border-slate-100 dark:border-slate-700" />

          {/* Row 2 â€” Chart Type */}
          <div className="flex items-center gap-3 px-4 py-2.5">
            <span className="flex h-8 w-8 items-center justify-center rounded-lg bg-violet-50 dark:bg-violet-900/30 text-lg shrink-0">
              ðŸ“Š
            </span>
            <p className="text-sm font-medium text-slate-800 dark:text-slate-200 flex-1">Chart Type</p>
            <div className="flex rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden">
              {['bar', 'line'].map(type => (
                <button
                  key={type}
                  type="button"
                  onClick={() => onSettingsChange({ chartType: type })}
                  className={`px-3 py-1 text-xs font-medium capitalize transition-colors ${
                    settings.chartType === type
                      ? 'bg-accent text-white'
                      : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'
                  }`}
                >
                  {type}
                </button>
              ))}
            </div>
          </div>

        </div>
      )}
    </div>
  )
}
```

**Important:** The `DateRangePickerPopover` component needs to support a `trigger` prop (custom trigger element). Update `DateRangePickerPopover.jsx` to accept and render a custom trigger:

In `src/components/DateRangePickerPopover.jsx`, update the component signature and trigger rendering:

```jsx
// Add `trigger` to the props:
export function DateRangePickerPopover({ value, onChange, align = 'left', trigger }) {
  // ...existing state and effects...

  // Replace the trigger button JSX at the bottom with:
  const triggerEl = trigger ? (
    <div ref={btnRef} onClick={() => setOpen(o => !o)} className="cursor-pointer">
      {trigger}
    </div>
  ) : (
    <button
      ref={btnRef}
      type="button"
      onClick={() => setOpen(o => !o)}
      className={`flex items-center gap-1.5 rounded-full border px-3 py-1.5 text-xs font-medium whitespace-nowrap transition-colors ${
        isActive
          ? 'border-accent text-accent bg-accent/5 dark:bg-accent/10'
          : 'border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-800 hover:border-slate-300 dark:hover:border-slate-600'
      }`}
    >
      <svg className="h-3.5 w-3.5 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
      {label}
    </button>
  )

  return (
    <div className="relative">
      {triggerEl}
      {/* ...popover unchanged... */}
    </div>
  )
}
```

**Step 2: Run tests**

```bash
node ./node_modules/.bin/vitest run
```
Expected: 67 tests pass.

**Step 3: Commit**

```bash
git add src/components/PlusMenu.jsx src/components/DateRangePickerPopover.jsx
git commit -m "feat: redesign PlusMenu as elegant list popover with date picker"
```

---

### Task 7: Replace InlineDateRange in PostCard with DateRangePickerPopover

**Files:**
- Modify: `src/components/PostCard.jsx`

**Step 1: Swap import**

In `src/components/PostCard.jsx`, replace the `InlineDateRange` import at line 3:

```jsx
/* BEFORE */
import { InlineDateRange } from './charts/InlineDateRange'

/* AFTER */
import { DateRangePickerPopover } from './DateRangePickerPopover'
```

**Step 2: Swap the component usage**

Find the `InlineDateRange` usage in the JSX (around line 234):

```jsx
/* BEFORE */
<div className="flex justify-end">
  <InlineDateRange value={dateRange} onChange={setDateRange} />
</div>

/* AFTER */
<div className="flex justify-end">
  <DateRangePickerPopover value={dateRange} onChange={setDateRange} align="right" />
</div>
```

**Step 3: Run tests**

```bash
node ./node_modules/.bin/vitest run
```
Expected: 67 tests pass.

**Step 4: Commit**

```bash
git add src/components/PostCard.jsx
git commit -m "feat: replace InlineDateRange with DateRangePickerPopover in PostCard"
```

---

### Task 8: Replace date select in ChartFilterBar with DateRangePickerPopover

**Files:**
- Modify: `src/components/ChartFilterBar.jsx`

**Step 1: Add import**

At the top of `src/components/ChartFilterBar.jsx`, add:

```jsx
import { DateRangePickerPopover } from './DateRangePickerPopover'
```

**Step 2: Remove the `DATE_PRESETS` array and `presetToDates` helper** (lines 3â€“18), since date calculation is now handled inside `DateRangePickerPopover`.

**Step 3: Remove the `datePreset` state and `handleDatePreset` handler** (around lines 47â€“65).

**Step 4: Replace the date `<select>` with `DateRangePickerPopover`**

In the JSX, replace the date preset `<select>` block (lines ~83â€“93):

```jsx
/* BEFORE */
<select
  value={datePreset}
  onChange={e => handleDatePreset(e.target.value)}
  className={pillClass(datePreset !== 'all')}
  style={{ backgroundImage: 'none' }}
>
  {DATE_PRESETS.map(p => (
    <option key={p.key} value={p.key}>{p.label}</option>
  ))}
</select>

/* AFTER */
<DateRangePickerPopover
  value={{ dateFrom: filters.dateFrom ?? '', dateTo: filters.dateTo ?? '' }}
  onChange={({ dateFrom, dateTo }) => {
    updateFilter('dateFrom', dateFrom)
    updateFilter('dateTo', dateTo)
  }}
/>
```

**Step 5: Update `handleReset`** â€” remove `setDatePreset('all')` from `handleReset` since that state no longer exists:

```jsx
/* BEFORE */
function handleReset() {
  setDatePreset('all')
  resetFilters()
}

/* AFTER */
function handleReset() {
  resetFilters()
}
```

**Step 6: Update `isActive` check** â€” the `hasActiveFilters` function already checks `filters.dateFrom || filters.dateTo`, so remove the `datePreset` argument:

```jsx
/* BEFORE */
const isActive = hasActiveFilters(filters, datePreset)

/* AFTER */
const isActive = hasActiveFilters(filters)
```

Also update the `hasActiveFilters` function signature:

```jsx
/* BEFORE */
function hasActiveFilters(filters, datePreset) {
  return (
    datePreset !== 'all' ||
    !!(filters.dateFrom || filters.dateTo ||
       filters.districts?.length  ||
       ...
  )
}

/* AFTER */
function hasActiveFilters(filters) {
  return !!(
    filters.dateFrom || filters.dateTo ||
    filters.districts?.length  ||
    filters.projects?.length   ||
    filters.propertyTypes?.length ||
    filters.layouts?.length    ||
    filters.saleTypes?.length
  )
}
```

**Step 7: Run tests**

```bash
node ./node_modules/.bin/vitest run
```
Expected: 67 tests pass.

**Step 8: Commit**

```bash
git add src/components/ChartFilterBar.jsx
git commit -m "feat: replace date preset select with DateRangePickerPopover in ChartFilterBar"
```

---

### Task 9: Version bump and push

**Files:**
- Modify: `package.json`

**Step 1: Bump version**

Open `package.json`. Change `"version": "1.1"` â†’ `"version": "1.2"`.

**Step 2: Final test run**

```bash
node ./node_modules/.bin/vitest run
```
Expected: 67 tests pass.

**Step 3: Commit and push**

```bash
git add package.json
git commit -m "chore: bump version to 1.2"
git push origin main
```

Expected: Vercel deploys with all UX polish changes.
